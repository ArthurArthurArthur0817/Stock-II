<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trade</title>
      <!-- Font: Noto Serif TC -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet"/>

  <!-- Bootstrap 4.5 -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.3/css/bootstrap.min.css"/>

  <!-- (å¯é¸) ä½ çš„å¤–éƒ¨æ¨£å¼ -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}"/>

  <style>
    /* 1) å…¨åŸŸé…è‰²ï¼ˆèˆ‡ account.html ä¸€è‡´ï¼‰ */
    :root{
      --primary:#043b8f;
      --primary-dark:#02347e;
      --primary-light:#6499e9;
      --secondary:#0b1f33;
    }

    /* 2) ç‰ˆé¢å­—å‹èˆ‡çµæ§‹ */
    html,body{height:100%;}
    body{
      display:flex;
      flex-direction:column;
      font-family:'Noto Serif TC',serif;
      line-height:1.6;
      background:transparent;
      margin:0;
    }
    h1,h2,h3,h4,h5,h6{
      font-family:'Noto Serif TC',serif;
      font-weight:700;
    }

    /* 3) èƒŒæ™¯å‹•ç•« */
    body::before{
      content:"";
      position:fixed;inset:0;
      background:url("https://png.pngtree.com/thumb_back/fh260/background/20231227/pngtree-gentle-blue-background-with-a-soft-textured-finish-image_13898387.png") center/cover no-repeat;
      filter:grayscale(20%) brightness(0.55);
      z-index:-1;
      animation:bgZoom 40s ease-in-out infinite alternate;
    }
    @keyframes bgZoom{from{transform:scale(1);}to{transform:scale(1.15);}}

    /* 4) ä¸»è¦å…§å®¹å¡ç‰‡ */
    .card-wrapper{
      background:rgba(255,255,255,.94);
      border-radius:.8rem;
      box-shadow:0 10px 30px rgba(0,0,0,.05);
      padding:2rem 2rem 2.5rem;
      margin-top:3rem;
      margin-bottom:3rem;
    }

    /* 5) æ¨™é¡Œèˆ‡å€å¡Š */
    h1{
      font-size:2rem;
      margin:1.2rem 0 1.8rem;
      text-align:center;
      color:var(--primary);
      letter-spacing:.03rem;
    }
    .section-title{
      font-size:1.25rem;
      color:var(--primary);
      margin-top:1.5rem;
      margin-bottom:.75rem;
    }

    /* 6) è¡¨å–®æ§åˆ¶é … */
    .form-control{
      border:1px solid #cbd3e0;
      border-radius:.5rem;
      text-align:left;
      box-shadow:none;
      padding:.75rem 1rem;
    }
    .form-group small{
      color:#6c757d;
    }

    /* 7) è¡¨æ ¼æ¨£å¼ï¼ˆç­–ç•¥çµæœï¼‰ */
    .table{
      background:#fff;
      border-radius:.5rem;
      overflow:hidden;
    }
    .table thead th{
      background:#f4f7fb;
      border-bottom:1px solid #e6ecf3;
      color:#223;
    }
    .table td, .table th{
      vertical-align:middle;
    }

    /* 8) æŒ‰éˆ•æ¨£å¼ */
    .btn{
      border-radius:2rem;
      font-weight:600;
    }
    .btn-primary{
      background-color:var(--primary);
      border-color:var(--primary);
      box-shadow:0 4px 8px rgba(0,0,0,.08);
      transition:box-shadow .3s ease, background-color .3s ease, border-color .3s ease;
    }
    .btn-primary:hover{
      background-color:var(--primary-dark);
      border-color:var(--primary-dark);
      box-shadow:0 6px 12px rgba(0,0,0,.12);
    }
    .btn-outline-primary{
      color:var(--primary);
      border-color:var(--primary);
      background-color:transparent;
      transition: background-color .3s ease, box-shadow .3s ease;
    }
    .btn-outline-primary:hover{
      background-color:var(--primary);
      color:#fff;
      box-shadow:0 6px 12px rgba(0,0,0,.1);
    }
    a.btn, button.btn { -webkit-tap-highlight-color: transparent; }
    .btn,
    .btn:focus,
    .btn.focus,
    .btn:active,
    .btn.active,
    .btn:focus:active,
    .btn:active:focus,
    .btn:focus-visible,
    .btn-primary,
    .btn-primary:focus,
    .btn-primary.focus,
    .btn-primary:active,
    .btn-primary.active,
    .btn-outline-primary,
    .btn-outline-primary:focus,
    .btn-outline-primary.focus,
    .btn-outline-primary:active,
    .btn-outline-primary.active,
    .show > .btn.dropdown-toggle,
    .show > .btn-primary.dropdown-toggle,
    .show > .btn-outline-primary.dropdown-toggle {
      outline: none !important;
      box-shadow: none !important;
      border-color: var(--primary) !important;
    }

    /* 9) å¡ç‰‡å…§è³‡è¨Šå€ */
    .info-box{
      background:#fff;
      border:1px solid #e6edf3;
      border-radius:.5rem;
      padding:1rem 1.25rem;
    }

    /* 10) AIå€å¡Š */
    .analysis-container{
      background:#fff;
      border:1px solid #e6edf3;
      border-radius:.5rem;
      padding:1rem 1.25rem;
      margin-top:1rem;
      white-space:pre-wrap;
    }

    /* è®“ã€ŒSubmit / Backã€ä¹‹é–“è·é›¢æ›´å¤§ï¼ˆæ­¤é  .actions æ˜¯ flex-columnï¼Œæ‰€ä»¥ gap è¡¨ç¤ºç¸±å‘é–“è·ï¼‰ */
    .actions {
    gap: 1.25rem;         /* ç¾ä»£ç€è¦½å™¨çš†æ”¯æ´ */
    }

    /* ä¿éšªï¼šè‹¥ç€è¦½å™¨ä¸æ”¯æ´ flex gapï¼Œå‚™æ´ç”¨ margin */
    @supports not (gap: 1rem) {
    .actions .btn + .btn { margin-top: 1.25rem; }
    }

    /* è®“ 5 å€‹æ¬„ä½é‚£ä¸€è¡Œèƒ½æ°´å¹³ç½®ä¸­ï¼ˆç¸½å¯¬ < 12 æ¬„æ™‚ç½®ä¸­å°é½Šï¼‰ */
    .form-row.justify-content-center {
    justify-content: center;
    }
  
/* åœ“å½¢ã€Œ?ã€é‡çœ‹æ•™å­¸æŒ‰éˆ• */
.tut-help{
  position:fixed; top:18px; right:18px; z-index:999;
  width:42px; height:42px; border-radius:999px; border:0;
  display:inline-flex; align-items:center; justify-content:center;
  font-weight:800; line-height:1; font-size:1rem;
  background:rgba(255,255,255,.92); color:var(--primary);
  box-shadow:0 6px 16px rgba(0,0,0,.14);
}
.tut-help:hover{ background:#fff; }
.tut-help:focus{ outline:none }
.tut-help:focus-visible{ box-shadow:0 0 0 3px rgba(4,59,143,.25), 0 6px 16px rgba(0,0,0,.14); }
/* iPhone ç€æµ·å®‰å…¨å€ */
@supports(padding:env(safe-area-inset-right)){
  .tut-help{ right:calc(14px + env(safe-area-inset-right)); top:calc(14px + env(safe-area-inset-top)); }
}

  </style>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/tutorial.css') }}">
</head>

</head>
<body>
  <button type="button" class="tut-help" data-action="show-tutorial" aria-label="é‡æ–°æŸ¥çœ‹ä½¿ç”¨æ•™å­¸" title="ä½¿ç”¨æ•™å­¸">?</button>

    <main class="flex-grow-1">
        <div class="container">
          <div class="card-wrapper">
            <h1>Trade Stocks</h1>

            <!-- flash è¨Šæ¯ï¼ˆå¯é¸ï¼‰ -->
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    <div aria-live="polite" aria-atomic="true" class="mb-3">
                        {% for category, msg in messages %}
                            <div class="alert alert-{{ 'danger' if category=='danger' else category }}" role="alert">
                                {{ msg }}
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
            {% endwith %}

            <!-- è‚¡ç¥¨æŸ¥è©¢è¡¨å–® -->
        <h4 class="section-title">è‚¡ç¥¨åç¨±</h4>
        <form method="POST" class="mb-3">
          <div class="form-row">
            <div class="form-group col-md-6">
              <input type="text" class="form-control" id="stock" name="stock" required placeholder="è«‹è¼¸å…¥ 4 ç¢¼å°è‚¡ä»£è™Ÿ">
              <small class="form-text">åƒ…æ”¯æ´ 4 ä½æ•¸å°è‚¡ä»£ç¢¼ï¼ˆä¾‹å¦‚ï¼š2330ï¼‰ã€‚</small>
            </div>
          </div>
            <div class="actions mt-3 d-flex flex-column align-items-center">
              <button type="submit" name="get_stock_info" class="btn btn-primary px-5 mb-2" >Get Stock Info</button>
            </div>
          
        </form>

            <!-- è‚¡ç¥¨è³‡è¨Šé¡¯ç¤º -->
            <h4 class="section-title">è‚¡ç¥¨è³‡è¨Š</h4>
            <div class="info-box mb-3">
              {% if stock_info %}
                <div><strong>åç¨±:</strong> {{ stock_info['name'] }}</div>
                <div><strong>ä»£è™Ÿ:</strong> {{ stock_info['symbol'] }}</div>
                <div><strong>ç”¢æ¥­åˆ¥:</strong> {{ stock_info['sector'] }}</div>
                <div><strong>å¸‚å€¼:</strong> {{ stock_info['market_cap'] }}</div>
                <div><strong>ç¾åƒ¹:</strong> {{ stock_info['current_price'] }}</div>
              {% else %}
                <div class="text-muted">ç›®å‰æ²’æœ‰è‚¡ç¥¨è³‡è¨Šã€‚è«‹å…ˆæŸ¥è©¢è‚¡ç¥¨ä»£ç¢¼ã€‚</div>
              {% endif %}
            </div>
            

            <!-- äº¤æ˜“è¡¨å–® -->
        {% if stock_info %}
        <form method="POST">
          <input type="hidden" name="stock" value="{{ stock_info['symbol'] }}">
          <input type="hidden" name="current_price" value="{{ stock_info['current_price'] }}">

          <div class="form-row justify-content-center">
            <div class="form-group col-md-2">
              <label for="type"><strong>äº¤æ˜“åˆ¥</strong></label>
              <select class="form-control" name="type" id="type">
                <option value="BUY">è²·é€²</option>
                <option value="SELL">è³£å‡º</option>
              </select>
            </div>

            <div class="form-group col-md-2">
              <label for="trade_category"><strong>äº¤æ˜“æ–¹å¼</strong></label>
              <select class="form-control" name="trade_category" id="trade_category">
                <option value="CASH">ç¾è‚¡</option>
              </select>
            </div>

            <div class="form-group col-md-2">
              <label for="market_session"><strong>äº¤æ˜“æ™‚æ®µ</strong></label>
              <select class="form-control" name="market_session" id="market_session">
                 <option value="REGULAR">æ™®é€š</option>
              </select>
            </div>

            <div class="form-group col-md-2">
               <label for="price"><strong>åƒ¹æ ¼</strong></label>
               <input type="number" step="0.01" class="form-control" name="price" id="price" required value="{{ stock_info['current_price'] }}">
            </div>
           

           <div class="form-group col-md-2">
            <label for="quantity"><strong>æ•¸é‡</strong></label>
            <input type="number" class="form-control" name="quantity" id="quantity" required placeholder="è«‹è¼¸å…¥å¼µæ•¸" min="1" step="1">
          </div>
        </div>
      
        <!-- âœ… æŠŠäº¤æ˜“æ™‚æ®µæç¤ºç§»åˆ° form-row å¤–ï¼Œé¿å…è¢«æ’çˆ† -->
        <div class="form-group">
          <small class="form-text">åƒ…å…è¨±æ–¼ä¸Šåˆ 9:00 è‡³ ä¸‹åˆ 1:30 é€²è¡Œäº¤æ˜“ã€‚</small>
          {% if not is_trading_time %}
            <div class="text-danger mt-1">ç›®å‰ä¸åœ¨äº¤æ˜“æ™‚æ®µã€‚ </div>
          {% endif %}
        </div>

            <!-- Submit & Back to Accountï¼ˆæŒ‰éˆ•ç¾¤çµ„ï¼ŒBack ç½®æ–¼ Submit ä¸‹æ–¹ï¼‰ -->
            <div class="actions mt-3 d-flex flex-column align-items-center">
              <button type="submit" name="submit_trade" class="btn btn-primary px-5 mb-4" {% if not is_trading_time %} disabled {% endif %}>Submit Trade</button>
              <a href="{{ url_for('account') }}" class="btn btn-outline-primary mb-4">Back to Account</a>
                
              {% if trade_feedback %}
                {% set status, msg = trade_feedback %}
                <div class="mt-3 alert alert-{{ 'success' if status=='success' else 'danger' }} text-center" role="alert" style="min-width:260px;">
                    {{ msg }}
                </div>
                {% endif %}
            </div>
          </form>
        {% endif %}



    
        <!-- ç­–ç•¥é¸æ“‡ -->
        {% if stock_info %}
            <form method="POST" class="mb-3">
                <div class="form-row">
                <div class="form-group col-md-6">
                    <label for="strategy"><strong>é¸æ“‡ç­–ç•¥</strong></label>
                    <select class="form-control" name="strategy" id="strategy">
                    <option value="momentum">Momentum Strategy</option>
                    <!-- <option value="mean_reversion">Mean Reversion Strategy</option> -->
                    <option value="breakout">Breakout Strategy</option>
                    <option value="fundamental">Fundamental Analysis</option>
                    <option value="rsi">RSI Strategy</option>
                    <option value="adx">ADX Strategy</option>
                    <option value="macd">MACD Strategy</option>
                    <option value="greedy">Greedy Strategy</option>
                    <option value="pricechannel">Price Channel Strategy</option>
                    <option value="bollingerbands">Bollinger Bands Strategy</option>
                    <option value="bollingerbandsdirected">Bollinger Bands Strategy Directed</option>
                    <option value="channelbreakout">Channel Break Out Strategy</option>
                    <option value="keltnerchannel">Keltner Channel Strategy</option>
                    <option value="sar">SAR Strategy</option>
                    <option value="ma">MA Strategy</option>
                    <option value="super">Super Trend Strategy</option>
                    <option value="bar">BarUpDn Strategy</option>
                    <option value="consecutive">Consecutive Up/Down Strategy</option>
                    <option value="insidebar">Inside Bar Strategy</option>
                    </select>
                </div>

                <!-- æŠ•è³‡é‡‘é¡ -->
                <div class="form-group col-md-6">
                    <label for="investment_amount"><strong>æŠ•è³‡é‡‘é¡</strong></label>
                    <input type="number" class="form-control" name="investment_amount" id="investment_amount" required placeholder="è«‹è¼¸å…¥æŠ•è³‡é‡‘é¡" min="0" step="1">
                </div>
                </div>
                <button type="submit" name="apply_strategy" class="btn btn-outline-primary px-4">Apply Strategy Analysis</button>
            </form>
            {% endif %}

        <!-- **ç­–ç•¥åˆ†æçµæœé¡¯ç¤ºåœ¨ç•«é¢ä¸‹æ–¹** -->
        {% if strategy_result %}
            <div class="analysis-container">
                <h5 class="mb-3">ç­–ç•¥åˆ†æçµæœ</h5>
                <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                    <tr><th>é …ç›®</th><th>æ•¸å€¼</th></tr>
                    </thead>
                    <tbody>
                    {% for key, value in strategy_result.items() %}
                        <tr>
                        <td>{{ key }}</td>
                        <td>{{ value }}</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
                </div>
            </div>
        {% endif %}


        <!-- AI åˆ†æèˆ‡å•ç­”ï¼ˆåƒ…åœ¨æœ‰ stock_info æ™‚é¡¯ç¤ºï¼‰ -->
        {% if stock_info %}
            <div class="text-center mt-4">
                <button type="button" id="aiAnalysisBtn" class="btn btn-outline-primary px-4">AI åˆ†æ</button>
            </div>

            <div id="ai_result_1" class="analysis-container" style="display:none;">
                <h5 class="mb-2">AI åˆ†æçµæœ</h5>
                <pre id="analysis-text">ğŸ”¹ å°šæœªé€²è¡ŒAIç­–ç•¥åˆ†æ</pre>
            </div>

            <!-- ä½¿ç”¨è€…è¼¸å…¥å€ -->
            <div id="user-response-container" class="analysis-container" style="display:none;">
                <h5 class="mb-2">è«‹è¼¸å…¥æ‚¨çš„å›ç­”ï¼š</h5>
                <textarea id="user-response" placeholder="è«‹è¼¸å…¥æ‚¨çš„å›ç­”..." class="form-control" style="height: 120px;"></textarea>
                <div class="mt-2">
                <button id="submit-response" class="btn btn-primary px-4">æäº¤</button>
                </div>
            </div>

            <!-- AI å•ç­”çµæœ -->
            <div id="ai_result_2" class="analysis-container" style="display:none;">
                <h5 class="mb-2">AI åˆ†æçµæœï¼š</h5>
                <pre id="ai-response-text">ğŸ”¹ å°šæœªé€²è¡ŒAIå•ç­”åˆ†æ</pre>
            </div>
        {% endif %}

    </div>
  </div>
</main>

    <!-- jQuery & Bootstrap JS -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // AI åˆ†æï¼šä¿æŒä½ åŸæœ¬çš„æµç¨‹ï¼Œä½†é…åˆæ–°çš„é¡¯ç¤ºå®¹å™¨
    (function(){
      const aiBtn = document.getElementById("aiAnalysisBtn");
      if (!aiBtn) return;

      aiBtn.addEventListener("click", function() {
        const textarea = document.getElementById("user-response");
        const button = document.getElementById("submit-response");
        const aiResult1 = document.getElementById("ai_result_1");
        const analysisText = document.getElementById("analysis-text");
        const responseContainer = document.getElementById("user-response-container");

        aiBtn.style.display = "none";
        if (textarea && button) { textarea.disabled = true; button.disabled = true; }

        fetch("/ai_analysis", { method: "POST" })
          .then(r => r.json())
          .then(data => {
            if (analysisText && data.analysis_result){
              analysisText.textContent = data.analysis_result;
              if (aiResult1) aiResult1.style.display = "block";
            }
            if (responseContainer){
              responseContainer.style.display = "block";
            }
            if (textarea && button) { textarea.disabled = false; button.disabled = false; }
          })
          .catch(err => {
            console.error("Error:", err);
            aiBtn.style.display = "inline-block";
          });
      });

      // é€å‡ºä½¿ç”¨è€…å›è¦† â†’ å„²å­˜ â†’ è§¸ç™¼ AI å•ç­”
      const submitBtn = document.getElementById("submit-response");
      if (submitBtn){
        submitBtn.addEventListener("click", function(){
          const textarea = document.getElementById("user-response");
          const text = (textarea?.value || '').trim();
          if (!text){ alert("âŒ è«‹è¼¸å…¥æ‚¨çš„å›ç­”ï¼"); return; }

          fetch("/save_question", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ question: text })
          })
          .then(r => r.json())
          .then(data => {
            alert(data.message || "Saved.");
            if (textarea) textarea.value = "";
            return fetch("/process_question", { method: "POST" });
          })
          .then(r => r.json())
          .then(data => {
            const aiResBox = document.getElementById("ai_result_2");
            const aiResText = document.getElementById("ai-response-text");
            if (aiResBox && aiResText){
              aiResText.textContent = data.response || "(no response)";
              aiResBox.style.display = "block";
            }
          })
          .catch(err => console.error("âŒ Error:", err));
        });
      }
    })();
  </script>
  <script src="{{ url_for('static', filename='js/tutorial.js') }}"></script>

  <script>
    (function(){
      if (typeof initImageTutorial !== 'function') { console.warn('[tutorial] tutorial.js not loaded'); return; }
      const tutTrade = initImageTutorial({
        pageKey: 'trade',
        version: 'img-v1',
        images: [
          "{{ url_for('static', filename='image/tutorial/03_trade_1.png') }}",
          "{{ url_for('static', filename='image/tutorial/03_trade_2.png') }}",
          "{{ url_for('static', filename='image/tutorial/03_trade_3.png') }}",
          "{{ url_for('static', filename='image/tutorial/03_trade_4.png') }}",
          "{{ url_for('static', filename='image/tutorial/03_trade_5.png') }}"
        ],
        autoShow: true,
        enableEsc: true
      });
      // ç¶å®šé‡çœ‹
      document.querySelectorAll('[data-action="show-tutorial"]').forEach(function(el){
        el.addEventListener('click', function(e){
          e.preventDefault(); try{ tutTrade.clear(); tutTrade.show(); }catch(_){}
        });
      });
    })();
  </script>

</body>
</html>
