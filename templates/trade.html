<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trade</title>
    <link rel="stylesheet" href="\static\style.css"> <!-- å¼•å…¥è‡ªè¨‚æ¨£å¼ -->
</head>
<body>
    <h1>Trade Stocks</h1>

    <!-- è‚¡ç¥¨è³‡è¨Šé¡¯ç¤º -->
    <div class="stock-info">
        {% if stock_info %}
            <h2>Stock Information</h2>
            <p><strong>Name:</strong> {{ stock_info['name'] }}</p>
            <p><strong>Symbol:</strong> {{ stock_info['symbol'] }}</p>
            <p><strong>Sector:</strong> {{ stock_info['sector'] }}</p>
            <p><strong>Market Cap:</strong> {{ stock_info['market_cap'] }}</p>
            <p><strong>Current Price:</strong> {{ stock_info['current_price'] }}</p>
        {% else %}
            <p>No stock information available. Please search for a stock symbol.</p>
        {% endif %}
    </div>

    <!-- è‚¡ç¥¨æŸ¥è©¢è¡¨å–® -->
    <form method="POST">
        <label for="stock">Stock Name:</label>
        <input type="text" name="stock" required placeholder="Enter 4-digit Taiwan stock code">
        <button type="submit" name="get_stock_info">Get Stock Info</button>
        <p style="font-size: 0.9em; color: gray;">Only 4-digit Taiwan stock codes are supported (e.g., 2330).</p>
    </form>

    <!-- äº¤æ˜“è¡¨å–® -->
    {% if stock_info %}
        <form method="POST">
            <input type="hidden" name="stock" value="{{ stock_info['symbol'] }}">
            <input type="hidden" name="current_price" value="{{ stock_info['current_price'] }}">

            <!-- äº¤æ˜“é¡å‹ -->
            <label for="type">Trade Type:</label>
            <select name="type">
                <option value="BUY">Buy</option>
                <option value="SELL">Sell</option>
            </select>

            <!-- äº¤æ˜“æ–¹å¼ -->
            <label for="trade_category">Trade Category:</label>
            <select name="trade_category">
                <option value="CASH">ç¾è‚¡</option>
            </select>

            <!-- ç›¤åˆ¥ -->
            <label for="market_session">Market Session:</label>
            <select name="market_session">
                <option value="REGULAR">æ™®é€š</option>
            </select>

            <!-- åƒ¹æ ¼ -->
            <label for="price">Price:</label>
            <input type="number" step="0.01" name="price" required value="{{ stock_info['current_price'] }}">

            <!-- æ•¸é‡ -->
            <label for="quantity">Quantity:</label>
            <input type="number" name="quantity" required placeholder="Enter quantity">

            <!-- æäº¤äº¤æ˜“ -->
            <button type="submit" name="submit_trade" {% if not is_trading_time %} disabled {% endif %}>Submit Trade</button>
            {% if not is_trading_time %}
                <p style="color: red;">Currently not within trading hours. Trading is only allowed from 9:00 AM to 1:30 PM.</p>
            {% endif %}
        </form>
    {% endif %}
    
    <!-- ç­–ç•¥é¸æ“‡ -->
    {% if stock_info %}
        <form method="POST">
            <label for="strategy">Select Strategy:</label>
            <select name="strategy">
                <option value="momentum">Momentum Strategy</option>
                <!--option value="mean_reversion">Mean Reversion Strategy</option-->
                <option value="breakout">Breakout Strategy</option>
                <option value="fundamental">Fundamental Analysis</option>
                <option value="rsi">RSI Strategy</option>
                <option value="adx">ADX Strategy</option>
                <option value="macd">MACD Strategy</option>
                <option value="greedy">Greedy Strategy</option>
                <option value="pricechannel">Price Channel Strategy</option>
                <option value="bollingerbands">Bollinger Bands Strategy</option>
                <option value="bollingerbandsdirected">Bollinger Bands Strategy Directed</option>
                <option value="channelbreakout">Channel Break Out Strategy</option>
                <option value="keltnerchannel">Keltner Channel Strategy</option>
            </select>

            <!-- æŠ•è³‡é‡‘é¡ -->
            <label for="investment_amount">Investment Amount:</label>
            <input type="number" name="investment_amount" required placeholder="Enter investment amount">

            <button type="submit" name="apply_strategy">Apply Strategy Analysis</button>
        </form>
    {% endif %}

    <!-- **ç­–ç•¥åˆ†æçµæœé¡¯ç¤ºåœ¨ç•«é¢ä¸‹æ–¹** -->
    {% if strategy_result %}
        <div class="strategy-result">
            <h2>Strategy Analysis Result</h2>
            <table class="strategy-table">
                <thead>
                    <tr>
                        <th>é …ç›®</th>
                        <th>æ•¸å€¼</th>
                    </tr>
                </thead>
                <tbody>
                    {% for key, value in strategy_result.items() %}
                    <tr>
                        <td>{{ key }}</td>
                        <td>{{ value }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% endif %}


    {% if stock_info %}    
        <div class="center">
            <button type="button" id="aiAnalysisBtn">AI åˆ†æ</button>
        </div>
        
        <div id="ai_result_1" class="analysis-container">
            <h2>AI åˆ†æçµæœ</h2>
            <pre id="analysis-text">ğŸ”¹ å°šæœªé€²è¡ŒAIç­–ç•¥åˆ†æ</pre>
        </div>
    

        <!-- ä½¿ç”¨è€…è¼¸å…¥å€ (åœ¨ AI åˆ†æçµæœä¸‹æ–¹) -->
        <div id="user-response-container" style="display: none; text-align: center; margin-top: 20px;">
            <h3>è«‹è¼¸å…¥æ‚¨çš„å›ç­”ï¼š</h3>
            <textarea id="user-response" placeholder="è«‹è¼¸å…¥æ‚¨çš„å›ç­”..." style="width: 80%; height: 100px; padding: 5px;"></textarea>
            <br>
            <button id="submit-response">æäº¤</button>
        </div>

            <!-- AI åˆ†æçµæœé¡¯ç¤ºå€ -->
        <div id="ai_result_2" class="analysis-container">  
            <h2>AI åˆ†æçµæœï¼š</h2>
            <pre id="ai-response-text" >ğŸ”¹ å°šæœªé€²è¡ŒAIå•ç­”åˆ†æ</pre>
        </div>
    {% endif %}
    
    <!-- JavaScript è™•ç† -->
    <script>
        document.getElementById("aiAnalysisBtn").addEventListener("click", function() {
            let aiButton = this; // å–å¾—æŒ‰éˆ•å…ƒç´ 
            aiButton.style.display = "none"; // ğŸ”¹ æŒ‰éˆ•é»æ“Šå¾Œéš±è—
            let textarea = document.getElementById("user-response");
            let button = document.getElementById("submit-response");

            if (textarea && button) {
                textarea.disabled = true;  
                button.disabled = true;  
            }

            fetch("/ai_analysis", {
                method: "POST",
            })
            .then(response => response.json())
            .then(data => {
                console.log("AI åˆ†æçµæœ:", data.analysis_result); // âœ… æª¢æŸ¥æ˜¯å¦æœ‰å›å‚³çµæœ

                let aiResultContainer = document.getElementById("ai_result_1");
                let analysisText = document.getElementById("analysis-text");

                if (aiResultContainer && data.analysis_result) {
                    analysisText.textContent = data.analysis_result;  // âœ… è¨­å®šæ–‡å­—å…§å®¹
                    aiResultContainer.style.display = "block";  // âœ… é¡¯ç¤ºå€å¡Š
                }


                // ğŸ”¹ ç¢ºä¿è¼¸å…¥æ¡†å€å¡Šå­˜åœ¨ï¼Œç„¶å¾Œé¡¯ç¤º
                let responseContainer = document.getElementById("user-response-container");
                if (responseContainer) {
                    responseContainer.style.display = "block"; 
                }

                // âœ… AI åˆ†æå®Œæˆå¾Œï¼Œæ¢å¾©è¼¸å…¥æ¡†
                if (textarea && button) {
                    textarea.disabled = false;
                    button.disabled = false;
                }
            })
            .catch(error => {
                console.error("Error:", error);
                aiButton.style.display = "block"; // ğŸ”¹ ç™¼ç”ŸéŒ¯èª¤æ™‚ï¼Œä¹Ÿè®“æŒ‰éˆ•é‡æ–°é¡¯ç¤º
            });
        });
        
    
        document.getElementById("submit-response").addEventListener("click", function() {
            let userResponse = document.getElementById("user-response").value.trim();
    
            if (userResponse === "") {
                alert("âŒ è«‹è¼¸å…¥æ‚¨çš„å›ç­”ï¼");
                return;
            }
    
            fetch("/save_question", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ question: userResponse })  
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);  
                document.getElementById("user-response").value = "";  
    
                // ğŸ”¹ å•é¡Œå„²å­˜æˆåŠŸå¾Œï¼Œå‘¼å« AI åˆ†æ
                return fetch("/process_question", { method: "POST" });
            })
            .then(response => response.json())
            .then(data => {
                console.log("ğŸ”¹ Gemini AI å›æ‡‰:", data.response);  
                
                let aiResultContainer = document.getElementById("ai_result_2");
                let aiResponseElement = document.getElementById("ai-response-text");
                if (aiResponseElement && aiResultContainer) {
                    aiResponseElement.textContent = data.response;  // âœ… é¡¯ç¤º learn.txt å…§å®¹
                    aiResultContainer.style.display = "block";  // âœ… é¡¯ç¤ºå€å¡Š
                } else {
                    console.error("âŒ æ‰¾ä¸åˆ° ai-response-text å…ƒç´ ï¼");
                }
            })
            .catch(error => console.error("âŒ Error:", error));
        });
    </script>
    
        
    
    <a href="{{ url_for('account') }}" class="btn">Back to Account</a>
</body>
</html>
