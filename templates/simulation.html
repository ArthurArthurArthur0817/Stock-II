<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>股票模擬交易</title>

  <!-- jQuery & Bootstrap -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- 你原本用的是 BS 5.3.3，保留即可 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- 全站字體：思源宋體（Noto Serif TC）-->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">

  <!-- (可選) 你的外部樣式 -->
  <link rel="stylesheet" href="\static\style.css">

  <style>
    /* ===== 1) 主題色票 ===== */
    :root{
      --primary:#043b8f;
      --primary-dark:#02347e;
      --primary-light:#6499e9;
      --secondary:#0b1f33;
      --ink:#0f172a;
    }

    /* ===== 2) 排版與背景 ===== */
    html,body{height:100%;}
    body{
      display:flex;
      flex-direction:column;
      font-family:'Noto Serif TC',serif;
      line-height:1.6;
      color:var(--ink);
      margin:0;
      background:transparent;
    }
    /* 背景動畫 */
    body::before{
      content:"";
      position:fixed; inset:0;
      background:url("https://png.pngtree.com/thumb_back/fh260/background/20231227/pngtree-gentle-blue-background-with-a-soft-textured-finish-image_13898387.png") center/cover no-repeat;
      filter:grayscale(20%) brightness(0.55);
      z-index:-2;
      animation:bgZoom 40s ease-in-out infinite alternate;
    }
    @keyframes bgZoom{from{transform:scale(1);}to{transform:scale(1.15);}}

    h1,h2,h3,h4,h5,h6{
      font-family:'Noto Serif TC',serif;
      font-weight:700;
    }

    /* ===== 3) 卡片容器 ===== */
    .card-wrapper{
      background:rgba(255,255,255,.94);
      border-radius:.8rem;
      box-shadow:0 10px 30px rgba(0,0,0,.05);
      padding:2rem 2rem 2.5rem;
      max-width:1100px;     /* 主卡片寬度 */
      width:100%;
      margin:3rem auto;
    }

    .stock-info h1{
      font-size:1.6rem;
      color:var(--primary);
      margin-bottom:.5rem;
      text-align:center;
    }
    .stock-info h3{
      font-size:1.1rem;
      margin:.25rem 0;
      text-align:center;
    }

    /* ===== 4) 走勢圖區 ===== */
    .chart-wrapper{
      margin-top:1.5rem;
      text-align:center;
    }
    #stock_chart{
      max-width:100%;
      height:auto;
      border-radius:.5rem;
      box-shadow:0 6px 18px rgba(0,0,0,.06);
      background:#fff;
    }

    /* ===== 5) 按鈕列（統一藍色主題、去除橘色）===== */
    .button-container{
      display:flex;
      flex-wrap:wrap;
      justify-content:center;
      gap:.6rem;
      margin-top:1rem;
    }
    .button-simulation{
      appearance:none;
      -webkit-appearance:none;
      -moz-appearance:none;
      padding:.6rem 1.25rem;
      border-radius:2rem;
      border:1.5px solid var(--primary);
      background:#fff;
      color:var(--primary);
      font-weight:700;
      transition:background .2s ease, color .2s ease, box-shadow .2s ease, transform .05s ease;
      cursor:pointer;
      box-shadow:none !important;
      outline:none !important;
    }
    .button-simulation:hover{
      background:var(--primary);
      color:#fff;
      box-shadow:0 8px 16px rgba(4,59,143,.18);
      transform:translateY(-1px);
    }
    .button-simulation:active,
    .button-simulation:focus{
      background:var(--primary);
      color:#fff;
      border-color:var(--primary);
      box-shadow:none !important;
      outline:none !important;
    }

    /* ===== 6) Loading & AI 結果卡 ===== */
    #loading{
      display:none;
      text-align:center;
      margin-top:15px;
    }
    #loading p{margin-top:10px; font-weight:bold; color:#004B97;}

    #ai_result{
      display:none;
      background-color:#fff;
      padding:15px;
      margin-top:20px;
      border-radius:10px;
      box-shadow:0 0 10px rgba(0,0,0,0.1);
      width:100%;
      max-width:900px;
      margin-left:auto; margin-right:auto; /* 置中 */
      text-align:left;
      white-space:pre-line; /* 保留換行 */
    }

    /* ===== 7) 左上角 Home 按鈕 ===== */
    .btn-home{
      position:fixed;
      top:20px; left:20px;
      display:inline-block;
      text-decoration:none;
      font-weight:700;
      padding:.6rem 1.25rem;
      border-radius:999px;
      border:1.5px solid var(--primary);
      background:#fff;
      color:var(--primary);
      transition:background .2s ease, color .2s ease, box-shadow .2s ease, transform .05s ease;
      z-index:1000;
      -webkit-tap-highlight-color: transparent;
    }
    .btn-home:hover{
      background:var(--primary);
      color:#fff;
      box-shadow:0 8px 16px rgba(4,59,143,.18);
      transform:translateY(-1px);
    }
    .btn-home:focus, .btn-home:active{
      outline:none !important;
      box-shadow:none !important;
      border-color:var(--primary) !important;
      background:var(--primary);
      color:#fff;
    }

    /* ===== 8) 下方教學區：讓排版更好看（可保留/調整）===== */
    .edu-section{
      background:rgba(255,255,255,.94);
      border-radius:.8rem;
      box-shadow:0 10px 30px rgba(0,0,0,.05);
      padding:1.5rem;
      max-width:1100px;
      width:100%;
      margin:0 auto 3rem auto;
    }
    .edu-section h1{
      font-size:1.5rem;
      color:var(--primary);
      text-align:center;
      margin-bottom:.5rem;
    }
    .edu-section h2{
      font-size:1.25rem;
      color:var(--primary);
      margin-top:1rem;
      margin-bottom:.5rem;
    }
    .edu-section table{
      width:100%;
      background:#fff;
      border:1px solid #e6ecf3;
      border-collapse:collapse;
    }
    .edu-section td, .edu-section th{
      border:1px solid #e6ecf3;
      padding:.75rem;
      vertical-align:top;
    }
    .edu-section img{
      max-width:100%;
      height:auto;
    }
  </style>
</head>
<body>
  <!-- 左上角：返回主畫面 -->
  <a href="{{ url_for('main') }}" class="btn-home">Home</a>

  <main class="flex-grow-1">
    <div class="container">
      <!-- 主卡片：走勢 & 操作區 -->
      <div class="card-wrapper">
        <div class="stock-info">
          <h1>當前顯示的股票：{{ stock_code }}</h1>
          <h3>當前股價：<span id="latest_price">{{ latest_price }}</span></h3>
          <h3>帳戶餘額：<span id="balance">{{ balance }}</span></h3>
          <h3>當前持有股票數：<span id="stock_count">0</span></h3>
        </div>

        <div class="chart-wrapper">
          <img id="stock_chart" src="{{ plot_path }}" alt="股票走勢圖">
          <div class="button-container">
            <button id="next_day_btn" class="button-simulation">下一天</button>
            <button id="buy_stock_btn" class="button-simulation">買入</button>
            <button id="sell_stock_btn" class="button-simulation">賣出</button>
            <button id="close_position_btn" class="button-simulation">平倉</button>
            <button id="settle_btn" class="button-simulation">結算</button>
            <button id="ai_analysis_btn" class="button-simulation" style="display:none;">AI 分析</button>
          </div>
        </div>

        <!-- Loading -->
        <div id="loading">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">分析中...</span>
          </div>
          <p>分析中，請稍候...</p>
        </div>

        <!-- AI 分析結果 -->
        <div id="ai_result">
          <p id="analysis_content"></p>
        </div>
      </div>

      <!-- 下方教學（原本內容移到美化後的卡片內） -->
      <div class="edu-section">
        <h1>K線組合型態</h1>
        <hr>
        <div>
          <h2>陽線</h2>
          <table>
            <tr>
              <td colspan="2"><h3 class="text-center">大陽線</h3></td>
              <td colspan="2"><h3 class="text-center">小陽線</h3></td>
            </tr>
            <tr>
              <td style="width:120px;"><div class="text-center"><img src="/static/img/picture/大陽線.png" width="55" height="187"></div></td>
              <td style="width:40%;">開盤價即為最低價，隨後股價一路上攻，最後收在股價最高點，代表買盤力道強勁。</td>
              <td style="width:120px;"><div class="text-center"><img src="/static/img/picture/小陽線.png" width="58" height="192"></div></td>
              <td>股價跌到低點時有買盤支撐，但漲到高點又遇到賣壓……通常是一種反轉訊號。（略）</td>
            </tr>
            <tr>
              <td colspan="2"><h3 class="text-center">光頭陽線</h3></td>
              <td colspan="2"><h3 class="text-center">光腳陰線</h3></td>
            </tr>
            <tr>
              <td><div class="text-center"><img src="/static/img/picture/螢幕擷取畫面 2025-01-08 191635.png" width="65" height="169"></div></td>
              <td>開盤後股價一度下跌，但因有買盤支撐，推升股價一路走升，最終收在最高價位……</td>
              <td><div class="text-center"><img src="/static/img/picture/螢幕擷取畫面 2025-01-08 191723.png" width="61" height="177"></div></td>
              <td>開盤後股價一度衝至最高點，但在高檔區遭遇賣壓……</td>
            </tr>
            <tr>
              <td colspan="2"><h3 class="text-center">陽線錘子</h3></td>
              <td colspan="2"><h3 class="text-center">倒線錘子</h3></td>
            </tr>
            <tr>
              <td><div class="text-center"><img src="/static/img/picture/陽錘.png" width="65" height="169"></div></td>
              <td>股價大跌之後，空方力道減弱……可視為股價底部支撐的訊號。</td>
              <td><div class="text-center"><img src="/static/img/picture/test.png" width="60" height="175" alt="A sample picture"></div></td>
              <td>股價大漲之後，多方力道減弱……上影線越長，代表賣壓越大。</td>
            </tr>
          </table>
        </div>

        <br><br>

        <div>
          <h2>陰線</h2>
          <table>
            <tr>
              <td colspan="2"><h3 class="text-center">大陰線</h3></td>
              <td colspan="2"><h3 class="text-center">小陰線</h3></td>
            </tr>
            <tr>
              <td style="width:120px;"><div class="text-center"><img src="/static/img/picture/大陰.png" width="55" height="187"></div></td>
              <td style="width:40%;">開盤價即是最高價，隨後股價一路下滑，最後收在最低點……</td>
              <td style="width:120px;"><div class="text-center"><img src="/static/img/picture/小陰線.png" width="58" height="192"></div></td>
              <td>多空勢均力敵程度較高時，常見為弱勢盤整。（略）</td>
            </tr>
            <tr>
              <td colspan="2"><h3 class="text-center">光頭陰線</h3></td>
              <td colspan="2"><h3 class="text-center">光腳陰線</h3></td>
            </tr>
            <tr>
              <td><div class="text-center"><img src="/static/img/picture/光頭陰線.png" width="65" height="169"></div></td>
              <td>開盤後一度下跌，最終收盤仍低於開盤價……</td>
              <td><div class="text-center"><img src="picture/光腳陰線.png" width="61" height="177"></div></td>
              <td>上檔賣壓沉重，最終拉回至最低價收盤……</td>
            </tr>
            <tr>
              <td colspan="2"><h3 class="text-center">陰線錘子</h3></td>
              <td colspan="2"><h3 class="text-center">倒錘陰線</h3></td>
            </tr>
            <tr>
              <td><div class="text-center"><img src="picture/陰線槌子.png" width="65" height="169"></div></td>
              <td>空頭轉向多頭或相反的常見訊號……</td>
              <td><div class="text-center"><img src="picture/倒陰錘.png" width="60" height="175"></div></td>
              <td>上影線越長，代表賣壓越沉重……</td>
            </tr>
          </table>
        </div>

        <br><br>

        <div>
          <h2>十字線</h2>
          <table>
            <tr>
              <td colspan="2"><h3 class="text-center">十字線</h3></td>
              <td colspan="2"><h3 class="text-center">T字線</h3></td>
            </tr>
            <tr>
              <td style="width:120px;"><div class="text-center"><img src="picture/十字線.png" width="55" height="187"></div></td>
              <td style="width:40%;">多空勢均力敵……高點出現易轉弱，低點出現易反彈。</td>
              <td style="width:120px;"><div class="text-center"><img src="picture/T字線.png" width="58" height="186"></div></td>
              <td>下影線越長，反彈力道越強……</td>
            </tr>
            <tr>
              <td colspan="2"><h3 class="text-center">一字線</h3></td>
              <td colspan="2"><h3 class="text-center">倒T字線</h3></td>
            </tr>
            <tr>
              <td><div class="text-center"><img src="picture/一字線.png" width="54" height="181"></div></td>
              <td>極端狀態或成交冷清時常見……</td>
              <td><div class="text-center"><img src="picture/倒T字線.png" width="61" height="177"></div></td>
              <td>若出現在上漲波段，代表轉弱機率大；上影線越長賣壓越重。</td>
            </tr>
          </table>
        </div>
      </div>
    </div>
  </main>

  <script>
    // 下一天
    $("#next_day_btn").click(function() {
      $.get("/next_day", function(data) {
        if (!data.error) {
          $("#stock_chart").attr("src", data.plot_path + "?t=" + new Date().getTime());
          $("#latest_price").text(data.latest_price);
        }
      });
    });

    $(document).ready(function() {
      updateStockCount();

      function updateStockCount() {
        $.get("/get_stock_count", function(data) {
          if (!data.error) {
            $("#stock_count").text(data.stock_count);
          }
        });
      }

      $("#buy_stock_btn").click(function() {
        $.post("/buy_stock", function(data) {
          if (data.success) {
            alert("買入成功！");
            $("#balance").text(data.balance);
            $("#stock_count").text(data.stock_count);
          } else {
            alert(data.error);
          }
        });
      });

      $("#sell_stock_btn").click(function() {
        $.post("/sell_stock", function(data) {
          if (data.success) {
            alert("賣出成功！");
            $("#balance").text(data.balance);
            $("#stock_count").text(data.stock_count);
          } else {
            alert(data.error);
          }
        });
      });

      $("#close_position_btn").click(function() {
        $.post("/close_position", function(data) {
          if (data.success) {
            alert("已成功平倉！");
            $("#stock_count").text(0);
            $("#balance").text(data.balance);
          } else {
            alert(data.error);
          }
        });
      });

      // 結算 -> 顯示 AI 分析按鈕
      $("#settle_btn").click(function() {
        alert("結算完成！");
        $("#ai_analysis_btn").show();
      });

      // AI 分析
      $("#ai_analysis_btn").click(function() {
        $("#loading").show();
        $("#analysis_content").text("");
        $("#ai_analysis_btn").hide();

        $.post("/run_ai_analysis", function(data) {
          $("#loading").hide();
          $("#ai_result").show();

          if (data.success) {
            $("#analysis_content").html(
              (data.analysis_result || "").replace(/\n/g, "<br>")
            );
          } else {
            $("#analysis_content").text("AI 分析失敗！");
          }

          $("#ai_analysis_btn").show();
        });
      });
    });
  </script>
</body>
</html>
