<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>投資報酬率試算</title>

  <!-- 思源宋體 -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
  <!-- Bootstrap 4.5 -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.3/css/bootstrap.min.css">
  <!-- 站內樣式（若有） -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">

  <style>
    :root{
      --primary:#043b8f;
      --primary-dark:#02347e;
      --primary-light:#6499e9;
      --secondary:#0b1f33;
    }
    html,body{height:100%;}
    body{
      display:flex;flex-direction:column;
      font-family:'Noto Serif TC',serif;
      line-height:1.6;
    }
    h1,h2,h3,h4,h5,h6{font-family:'Noto Serif TC',serif;font-weight:700;}
    h1{font-size:2rem;margin:1.5rem 0 2rem;text-align:center;}

    /* 背景動畫 */
    body::before{
      content:"";position:fixed;inset:0;
      background:url("https://png.pngtree.com/thumb_back/fh260/background/20231227/pngtree-gentle-blue-background-with-a-soft-textured-finish-image_13898387.png") center/cover no-repeat;
      filter:grayscale(20%) brightness(0.55);
      z-index:-2;animation:bgZoom 40s ease-in-out infinite alternate;
    }
    @keyframes bgZoom{from{transform:scale(1);}to{transform:scale(1.15);}}

    /* 卡片包裝 */
    .card-wrapper{
      background:rgba(255,255,255,.94);
      border-radius:.8rem;
      box-shadow:0 10px 30px rgba(0,0,0,.05);
      padding:2rem 2rem 3rem;
    }

    /* Home 按鈕 */
    .btn-home{
      display:inline-block;text-decoration:none;font-weight:700;
      padding:.6rem 1.25rem;border-radius:999px;
      border:1.5px solid var(--primary);background:#fff;color:var(--primary);
      transition:background .2s ease,color .2s ease,box-shadow .2s ease,transform .05s ease;
      -webkit-tap-highlight-color: transparent;
    }
    .btn-home:hover{background:var(--primary);color:#fff;box-shadow:0 8px 16px rgba(4,59,143,.18);transform:translateY(-1px);}
    .btn-home:active{transform:translateY(0);box-shadow:0 4px 8px rgba(4,59,143,.18);}
    .btn-home,.btn-home:focus,.btn-home:active,.btn-home:focus-visible{outline:none!important;box-shadow:none!important;border-color:var(--primary)!important;}

    /* 表單 */
    .form-label{font-weight:700;}
    .form-control{border:1px solid #e3e7ef;}
    .form-control:focus{border-color:var(--primary-light);box-shadow:0 0 0 .2rem rgba(4,59,143,.15);}

    /* 頁腳 */
    footer{background:var(--secondary);color:#fff;text-align:center;}
    footer h5{font-size:1.125rem;margin-bottom:1rem;}
    footer ul{list-style:none;padding-left:0;margin-bottom:1.5rem;}
    footer li{margin-bottom:.25rem;}
    footer .copyright{border-top:1px solid rgba(255,255,255,.72);margin-top:2rem;padding-top:1rem;font-size:.875rem;color:#ccc;}

    /* Loading Overlay */
    #loadingOverlay{
      position:fixed; inset:0; z-index:9999;
      display:none; align-items:center; justify-content:center;
      background:rgba(11,31,51,0.35);
      backdrop-filter: blur(2px);
    }
    #loadingOverlay.active{ display:flex; }
    .loader-wrap{ text-align:center; color:#fff; font-weight:700; letter-spacing:.03em; }
    .spinner{
      width:56px; height:56px; border-radius:50%;
      border:4px solid rgba(255,255,255,0.35);
      border-top-color:#ffffff;
      animation:spin 0.9s linear infinite;
      margin:0 auto;
    }
    @keyframes spin{to{transform:rotate(360deg);}}
    .loading-text{ font-size:1rem; text-shadow:0 2px 8px rgba(0,0,0,.25); }

    /* 圓形「?」重看教學按鈕（固定右上） */
    .tut-help{
      position:fixed; top:18px; right:18px; z-index:1001;
      width:42px; height:42px; border-radius:999px; border:0;
      display:inline-flex; align-items:center; justify-content:center;
      font-weight:800; line-height:1; font-size:1rem;
      background:rgba(255,255,255,.92); color:var(--primary, #043b8f);
      box-shadow:0 6px 16px rgba(0,0,0,.14);
    }
    .tut-help:hover{ background:#fff; }
    .tut-help:focus{ outline:none }
    .tut-help:focus-visible{ box-shadow:0 0 0 3px rgba(4,59,143,.25), 0 6px 16px rgba(0,0,0,.14); }
    /* iPhone 瀏海安全區 */
    @supports(padding:env(safe-area-inset-right)){
      .tut-help{ right:calc(14px + env(safe-area-inset-right)); top:calc(14px + env(safe-area-inset-top)); }
    }
    
  </style>
   <link rel="stylesheet" href="{{ url_for('static', filename='css/tutorial.css') }}">
</head>
<body>
    <button type="button" class="tut-help" data-action="show-tutorial" aria-label="重新查看使用教學" title="使用教學">?</button>

    <main class="flex-grow-1">
    <div class="container mt-5 mb-5 card-wrapper">
      <div class="mb-3">
        <!-- 回到 ROI 首頁（避免未定義的 main endpoint） -->
        <a href="{{ url_for('main') }}" class="btn-home">Home</a>
      </div>

      <div class="row justify-content-center">
        <div class="col-lg-8 col-md-10">
          <h1>RETURN ON INVESTMENT</h1>
            <!-- 全域訊息（flash） -->
            {% with messages = get_flashed_messages(with_categories=True) %}
              {% if messages %}
                {% for category, message in messages %}
                  <div class="alert alert-{{ 'danger' if category in ['error','danger'] else category }} alert-dismissible fade show" role="alert" aria-live="polite">
                    {{ message }}
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                      <span aria-hidden="true">&times;</span>
                    </button>
                  </div>
                {% endfor %}
              {% endif %}
            {% endwith %}

          <form action="{{ url_for('calculate') }}" method="POST">
            <div class="form-group">
              <label class="form-label" for="ticker">台股代號</label>
              <input
                type="text"
                class="form-control form-control-lg {% if errors and errors.ticker %}is-invalid{% endif %}"
                id="ticker"
                name="ticker"
                placeholder="例如：2330"
                required
                pattern="\d{4}"
                inputmode="numeric"
                value="{{ form.ticker if form else '' }}"
                aria-describedby="tickerHelp tickerFeedback"
              />
              <small id="tickerHelp" class="form-text text-muted">請輸入 4 位數台股代號，例如 2330。</small>
              <div id="tickerFeedback" class="invalid-feedback">
                {{ errors.ticker if errors and errors.ticker else '' }}
              </div>

            </div>

            <div class="form-group">
              <label class="form-label" for="amount">投資金額（TWD）</label>
              <input
                type="number"
                class="form-control form-control-lg {% if errors and errors.amount %}is-invalid{% endif %}"
                id="amount"
                name="amount"
                min="1"
                step="1"
                placeholder="例如：100000"
                required
                value="{{ form.amount if form else '' }}"
              />
              <div class="invalid-feedback">
                {{ errors.amount if errors and errors.amount else '' }}
              </div>

            </div>

            <div class="form-group">
              <label class="form-label" for="period">投資期間</label>
              <select class="form-control form-control-lg" id="period" name="period" required>
                <option value="1d" {{ 'selected' if form and form.period=='1d' else '' }}>近 1 交易日</option>
                <option value="5d" {{ 'selected' if form and form.period=='5d' else '' }}>近 5 交易日</option>
                <option value="1m" {{ 'selected' if not form or form.period=='1m' else '' }}>近 1 個月</option>
                <option value="3m" {{ 'selected' if form and form.period=='3m' else '' }}>近 3 個月</option>
                <option value="6m" {{ 'selected' if form and form.period=='6m' else '' }}>近 6 個月</option>
                <option value="1y" {{ 'selected' if form and form.period=='1y' else '' }}>近 1 年</option>
              </select>

            </div>

            <div class="text-center mt-4">
              <button type="submit" class="btn btn-primary btn-lg px-5">開始試算</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  
    <!-- Loading Overlay -->
    <div id="loadingOverlay" aria-hidden="true">
      <div class="loader-wrap" role="status" aria-live="polite">
        <div class="spinner"></div>
        <div class="loading-text mt-3">資料計算中，請稍候…</div>
      </div>
    </div>
    
  </main>

  <footer class="py-5">
    <div class="container">
      <h5 class="text-white">貼心提醒</h5>
      <ul>
        <li>本工具僅供教育用途，實際投資請自行評估風險。</li>
        <li>資料來源為最近交易資料，若遇節假日或停牌，顯示區間可能縮短。</li>
      </ul>
      <div class="copyright">© 2025 投資工具平台 All rights reserved.</div>
    </div>
  </footer>

  <!-- jQuery & Bootstrap JS -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    (function(){
      var form = document.querySelector(`form[action="{{ url_for('calculate') }}"]`);
      var overlay = document.getElementById('loadingOverlay');
      var submitBtn = form ? form.querySelector('button[type="submit"]') : null;
      if(form && overlay){
        form.addEventListener('submit', function(e){
          if(!form.checkValidity()){ return; }
          if(submitBtn){
            submitBtn.disabled = true;
            submitBtn.dataset.originalText = submitBtn.textContent;
            submitBtn.textContent = '計算中…';
          }
          overlay.classList.add('active');
        }, false);
      }
      window.addEventListener('pageshow', function(event){
        if (event.persisted && overlay){ overlay.classList.remove('active'); }
        if (submitBtn && submitBtn.dataset && submitBtn.dataset.originalText){
          submitBtn.textContent = submitBtn.dataset.originalText;
          submitBtn.disabled = false;
        }
      });
    })();
  </script>

  <script src="{{ url_for('static', filename='js/tutorial.js') }}"></script>

  <script>
    (function(){
      if (typeof initImageTutorial !== 'function') { console.warn('[tutorial] tutorial.js not loaded'); return; }
      const tutROI = initImageTutorial({
        pageKey: 'roi',
        version: 'img-v1',
        images: [
          "{{ url_for('static', filename='image/tutorial/05_roi_1.png') }}",
          "{{ url_for('static', filename='image/tutorial/05_roi_2.png') }}"
        ],
        autoShow: true,
        enableEsc: true
      });
      // 綁定重看
      document.querySelectorAll('[data-action="show-tutorial"]').forEach(function(el){
        el.addEventListener('click', function(e){
          e.preventDefault(); try{ tutROI.clear(); tutROI.show(); }catch(_){}
        });
      });
    })();
  </script>
    
</body>
</html>
