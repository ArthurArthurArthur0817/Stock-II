<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>近期新聞 - {{ stock_name }} </title>

  <!-- 1) Critical: 先注入 overlay 與基礎排版的最小 CSS，避免尚未載入就看不到 -->
  <style>
    :root{
      --primary:#043b8f;
      --primary-light:#6499e9;
      --secondary:#0b1f33;
    }
    html,body{height:100%;}
    /* 先畫出背景底色，避免白屏 */
    body{margin:0; background:#f2f5fb; font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans TC', sans-serif;}
    /* Loading overlay（critical） */
    #loading-overlay{
      position: fixed; inset: 0;
      display: flex; align-items: center; justify-content: center;
      background: rgba(255,255,255,.96);
      z-index: 9999;
      transition: opacity .4s ease;
      font-weight: 700; color: var(--primary);
      letter-spacing:.02em;
    }
    #loading-overlay.hidden{ opacity:0; pointer-events:none; }
    .spinner{
      width: 56px; height: 56px; border-radius: 50%;
      border: 4px solid #e0e6f7; border-top-color: var(--primary);
      animation: spin 1s linear infinite; margin: 0 auto 12px;
    }
    @keyframes spin{ to{ transform: rotate(360deg);} }
    .loading-box{ text-align:center; }
    .loading-sub{ font-size:.95rem; color:#4d6aa3; opacity:.9; }
    /* Skeleton（可選） */
    .skeleton{ background:linear-gradient(90deg, #eef2ff 25%, #f6f8ff 37%, #eef2ff 63%); background-size:400% 100%; animation: shimmer 1.4s infinite; }
    @keyframes shimmer{ 0%{background-position:0 0;} 100%{background-position:100% 0;} }
    .skeleton-line{height:14px;border-radius:8px;margin:8px 0;}
    .skeleton-pill{height:28px;width:92px;border-radius:999px;display:inline-block;}
  </style>

  <!-- 字體（次要，非必要，避免阻塞） -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">

  <!-- 2) 非 critical 的樣式 -->
  <style>
    /* 背景圖延後載入：先不要阻塞首屏（在 JS 中 lazy 啟用） */
    body.has-bg::before{
      content:""; position:fixed; inset:0;
      background:url("https://png.pngtree.com/thumb_back/fh260/background/20231227/pngtree-gentle-blue-background-with-a-soft-textured-finish-image_13898387.png") center/cover no-repeat;
      filter:grayscale(20%) brightness(0.55);
      z-index:-2; animation:bgZoom 40s ease-in-out infinite alternate;
    }
    @keyframes bgZoom{from{transform:scale(1);}to{transform:scale(1.15);}}

    .container{max-width:1100px;margin:3rem auto;padding:0 1rem;}
    .card-wrapper{
      background:rgba(255,255,255,.94);
      border-radius:.8rem;
      box-shadow:0 10px 30px rgba(0,0,0,.05);
      padding:2rem 2rem 2.5rem;
      font-family:'Noto Serif TC', serif;
    }
    h1{ font-size:2rem; font-weight:700; text-align:center; margin:0 0 1.5rem 0; }

    .alert{ border-radius:.5rem; padding:1rem 1.25rem; margin-bottom:1.25rem; border:1px solid transparent; }
    .alert-danger{background:#fff;border-color:#c42030;color:#c42030;}
    .alert-warning{background:#fff7e6;border-color:#ffcd8a;color:#a66300;}

    .table-wrap{overflow:auto;}
    table{ width:100%; border-collapse:separate; border-spacing:0; background:#fff; border-radius:.6rem; overflow:hidden; }
    thead th{ text-align:left; background:#f5f7fb; color:#111; font-weight:700; padding:.875rem 1rem; border-bottom:1px solid #e6e9f2; white-space:nowrap; }
    tbody td{ padding:.875rem 1rem; border-bottom:1px solid #eef1f7; vertical-align:top; }
    tbody tr:last-child td{ border-bottom:none; }

    .news-row{ cursor:pointer; }
    .news-row:hover{ background:#f0f4ff; }
    .news-row:focus{ outline:2px solid var(--primary-light); background:#f5f9ff; }

    td .title{ display:block; font-weight:600; }
    .btn{ display:inline-block; padding:.5rem 1rem; border:1.5px solid var(--primary); background:transparent; color:var(--primary); border-radius:.5rem; text-decoration:none; font-weight:600; transition:transform .06s ease; cursor:pointer; text-align:center; white-space:nowrap; }
    .btn:hover{transform:translateY(-1px);} .btn:active{transform:translateY(0);}
    .btn-primary{ background:transparent; color:var(--primary); border-color:var(--primary); }

    .text-center{text-align:center;}
    .mt-4{margin-top:1.5rem;}
    .px-4{padding-left:1rem;padding-right:1rem;}

    footer{ background:var(--secondary); color:#fff; text-align:center; margin-top:auto; padding:2rem 0; }
    footer .copyright{ border-top:1px solid rgba(255,255,255,.72); margin-top:1rem; padding-top:1rem; font-size:.9rem; color:#cccccc; }

    @media (max-width: 576px){
      thead th:nth-child(1), tbody td:nth-child(1){ width:48px; }
      thead th:nth-child(5), tbody td:nth-child(5){ width:92px; white-space:nowrap; }
    }
  </style>
</head>
<body>
  <!-- Loading overlay（會在 DOMContentLoaded 後淡出；保證至少顯示 600ms） -->
  <div id="loading-overlay" aria-live="polite" aria-busy="true">
    <div class="loading-box">
      <div class="spinner"></div>
      <div>載入中，請稍候…</div>
      <div class="loading-sub">Loading…</div>
    </div>
  </div>

  <main>
    <div class="container">
      <div class="card-wrapper" id="content-root">
        <h1>📢 {{ stock_name }} 近期新聞 </h1>

        {% if error %}
          <div class="alert alert-danger" id="error-message">{{ error }}</div>
        {% elif news_list %}
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th style="width:60px;"></th>
                  <th>標題</th>
                  <th style="width:140px;">來源</th>
                  <th style="width:160px;">時間</th>
                  <th style="width:100px;">連結</th>
                </tr>
              </thead>
              <tbody id="news-tbody">
                {% for news in news_list %}
                <tr class="news-row" data-href="{{ news['link'] }}" tabindex="0" title="點擊閱讀新聞：{{ news['title'] }}">
                  <td class="text-muted">{{ loop.index }}</td>
                  <td><span class="title">{{ news['title'] }}</span></td>
                  <td>{{ news['media'] }}</td>
                  <td>{{ news['date'] }}</td>
                  <td><a class="btn btn-primary" href="{{ news['link'] }}" target="_blank" rel="noopener">閱讀</a></td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="alert alert-warning">⚠️ 目前沒有可用新聞，請稍後再試！</div>
        {% endif %}

        <div class="text-center mt-4">
          <a href="{{ url_for('main') }}" class="btn btn-primary px-4">回到首頁</a>
        </div>
      </div>
    </div>
  </main>

  <footer>
    <div class="container">
      <div class="copyright">© 2025 AI 投資新手智慧學習平台</div>
    </div>
  </footer>

  <script>
    // 1) 整列可點 & 鍵盤可用
    (function () {
      function openRow(tr) {
        var href = tr && tr.getAttribute('data-href');
        if (href) window.open(href, '_blank', 'noopener');
      }
      document.addEventListener('click', function (e) {
        var tr = e.target.closest('.news-row');
        if (tr) openRow(tr);
      });
      document.addEventListener('keydown', function (e) {
        if ((e.key === 'Enter' || e.key === ' ') && e.target.classList.contains('news-row')) {
          e.preventDefault();
          openRow(e.target);
        }
      });
    })();

    // 2) Loading overlay：在 DOM 解析完成後就關閉（比 window.load 更早）
    (function () {
      var overlay = document.getElementById('loading-overlay');
      var start = performance.now();
      function hideOverlay() {
        var elapsed = performance.now() - start;
        var minDuration = 600; // 至少顯示 600ms，避免一閃而過
        var delay = Math.max(0, minDuration - elapsed);
        setTimeout(function () {
          overlay.classList.add('hidden');
          // 背景圖延後啟用，避免阻塞首屏
          document.body.classList.add('has-bg');
        }, delay);
      }
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', hideOverlay);
      } else {
        // 若很快就 ready，也保證最小顯示時間
        hideOverlay();
      }
    })();

    // 3) 導航前顯示 overlay（點站內連結或提交表單時）
    (function () {
      function showOverlay() {
        var overlay = document.getElementById('loading-overlay');
        overlay.classList.remove('hidden');
      }
      document.addEventListener('click', function (e) {
        var a = e.target.closest('a[href]');
        if (a && a.getAttribute('target') !== '_blank' && a.origin === location.origin) {
          // 站內導覽且非新分頁
          showOverlay();
        }
      }, true);
      document.addEventListener('submit', function () {
        showOverlay();
      }, true);
      // 當使用者刷新或上一頁時
      window.addEventListener('beforeunload', function () { showOverlay(); });
    })();
  </script>
</body>
</html>
